---
name: Update Transcript Daily

on:
  schedule:
    # Run at midnight UTC every day
    - cron: '0 0 * * *'
  workflow_dispatch:  # Allow manual triggering for testing

jobs:
  update-transcript:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Allow pushing changes to the repository
      actions: write   # Allow triggering other workflows
      models: read # Allow access to GitHub Models

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests openai

      - name: Update transcript data
        id: update_transcript
        env:
          LOCALE: ${{ vars.LOCALE }}
        run: |
          if python passed_exams.py "${{ secrets.TRANSCRIPT_CODE }}" \
            --output passed_exams.csv; then
            echo "transcript_check_successful=true" >> $GITHUB_OUTPUT
            echo "Transcript check completed successfully"
          else
            echo "transcript_check_successful=false" >> $GITHUB_OUTPUT
            echo "Transcript check failed"
            exit 1
          fi

      - name: Update Credly data
        id: update_credly
        if: steps.update_transcript.outputs.transcript_check_successful == 'true'
        run: |
          if python fetch_credly_badges.py "${{ vars.CREDLY_USERNAME }}" \
            --output credly_badges.csv; then
            echo "credly_check_successful=true" >> $GITHUB_OUTPUT
            echo "Credly badges check completed successfully"
          else
            echo "credly_check_successful=false" >> $GITHUB_OUTPUT
            echo "Credly badges check failed, continuing with existing data"
          fi

      - name: Generate AI exam recommendation
        id: ai_recommendation
        if: steps.update_transcript.outputs.transcript_check_successful == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if python ai_exam_recommender.py; then
            echo "ai_recommendation_successful=true" >> $GITHUB_OUTPUT
            echo "AI recommendation generated successfully"
          else
            echo "ai_recommendation_successful=false" >> $GITHUB_OUTPUT
            echo "AI recommendation failed, continuing with default"
          fi

      - name: Commit and push changes
        id: commit_changes
        if: steps.update_transcript.outputs.transcript_check_successful == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add passed_exams.csv credly_badges.csv partials/ai-recommendation.html
          if git diff --cached --quiet; then
            echo "No changes to commit"
            echo "changes_made=false" >> $GITHUB_OUTPUT
          else
            git commit -m "Update passed_exams.csv, credly_badges.csv and AI recommendation with latest data"
            git push
            echo "changes_made=true" >> $GITHUB_OUTPUT
          fi

      - name: Trigger Azure Static Web Apps deployment
        if: steps.update_transcript.outputs.transcript_check_successful == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'azure-static-web-apps-purple-pond-0cdaaa710.yml',
              ref: 'main'
            });
